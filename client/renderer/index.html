<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Vault</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- zxcvbn for password strength checking -->
    <script src="https://cdn.jsdelivr.net/npm/zxcvbn@4.4.2/dist/zxcvbn.js"></script>
    <script src="clipboardManager.js"></script>
  </head>
  <body>
    <div class="container">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span id="themeIcon">üåô</span>
      </button>
      <div class="app-header">
        <h1>üîí Secure Vault</h1>
      </div>

      <!-- Authentication Section -->
      <div class="auth-container" id="authSection">
        <div class="auth-card">
          <h2>Authentication</h2>
        <div id="authMessage" class="message"></div>
        
        <!-- Login Form -->
        <div id="loginForm">
          <h3>Login</h3>
          <div class="form-group">
            <label for="loginUsername">Username:</label>
            <input type="text" id="loginUsername" placeholder="Enter username" />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter password" />
          </div>
          <button onclick="login()">Login</button>
          <button class="secondary" onclick="showRegister()">Switch to Register</button>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="hidden">
          <h3>Register</h3>
          <div class="form-group">
            <label for="registerUsername">Username:</label>
            <input type="text" id="registerUsername" placeholder="Enter username" />
          </div>
          <div class="form-group">
            <label for="registerPassword">Password:</label>
            <input type="password" id="registerPassword" placeholder="Enter password (min 6 characters)" />
          </div>
          <button onclick="register()">Register</button>
          <button class="secondary" onclick="showLogin()">Switch to Login</button>
        </div>
        </div>
      </div>

      <!-- Master Password Modal -->
      <div id="masterPasswordModal" class="modal">
        <div class="modal-content">
          <h2>üîê Enter Master Password</h2>
          <p>Your master password is used to encrypt and decrypt your entries. It is never saved and only stored in memory for this session.</p>
          <div class="form-group">
            <label for="masterPasswordInput">Master Password:</label>
            <input type="password" id="masterPasswordInput" placeholder="Enter master password" autofocus 
                   onkeypress="if(event.key === 'Enter') submitMasterPassword()" />
          </div>
          <div id="masterPasswordError" class="message error" style="display: none;"></div>
          <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
            <button onclick="submitMasterPassword()">Unlock</button>
            <button class="danger" onclick="logout()">Logout</button>
          </div>
          <p style="margin-top: 15px; font-size: 12px; color: #999;">Press Enter to submit</p>
        </div>
      </div>

      <!-- Locked Overlay -->
      <div id="lockedOverlay" class="locked-overlay">
        <div class="locked-content">
          <h2>üîí Application Locked</h2>
          <p>The application has been locked due to inactivity. Please enter your master password to continue.</p>
          <div class="form-group">
            <label for="unlockPasswordInput">Master Password:</label>
            <input type="password" id="unlockPasswordInput" placeholder="Enter master password" autofocus 
                   onkeypress="if(event.key === 'Enter') unlockApplication()" />
          </div>
          <div id="unlockError" class="message error" style="display: none;"></div>
          <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
            <button onclick="unlockApplication()">Unlock</button>
            <button class="danger" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>

      <!-- Create Vault Modal -->
      <div id="createVaultModal" class="modal">
        <div class="modal-content">
          <h2>‚ûï Create New Vault</h2>
          <div class="form-group">
            <label for="newVaultName">Vault Name:</label>
            <input type="text" id="newVaultName" placeholder="Enter vault name" autofocus 
                   onkeypress="if(event.key === 'Enter') createVault()" />
          </div>
          <div class="form-group">
            <label for="createVaultMasterPassword">Master Password:</label>
            <input type="password" id="createVaultMasterPassword" placeholder="Enter your master password" 
                   onkeypress="if(event.key === 'Enter') createVault()" />
          </div>
          <div id="createVaultError" class="message error" style="display: none;"></div>
          <div class="form-actions">
            <button onclick="createVault()">Create</button>
            <button class="secondary" onclick="hideCreateVaultModal()">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Accept Invite Modal -->
      <div id="acceptInviteModal" class="modal">
        <div class="modal-content">
          <h2>üéüÔ∏è Accept Vault Invite</h2>
          <p>Enter the invite code shared by the vault owner to access this vault.</p>
          <div class="form-group">
            <label for="inviteCodeInput">Invite Code:</label>
            <input type="text" id="inviteCodeInput" placeholder="Enter invite code" autofocus 
                   onkeypress="if(event.key === 'Enter') acceptInvite()" />
          </div>
          <div class="form-group">
            <label for="acceptInviteMasterPassword">Your Master Password:</label>
            <input type="password" id="acceptInviteMasterPassword" placeholder="Enter your master password" 
                   onkeypress="if(event.key === 'Enter') acceptInvite()" />
          </div>
          <div id="acceptInviteError" class="message error" style="display: none;"></div>
          <div class="form-actions">
            <button onclick="acceptInvite()">Unlock Vault</button>
            <button class="secondary" onclick="hideAcceptInviteModal()">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Manage Vault Modal -->
      <div id="manageVaultModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
          <h2>‚öôÔ∏è Manage Vault</h2>
          <div id="vaultInfo" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 4px;">
            <strong>Vault:</strong> <span id="managedVaultName"></span><br>
            <strong>Type:</strong> <span id="managedVaultType"></span>
          </div>

          <div id="vaultMembersSection" style="display: none;">
            <h3 style="margin-top: 20px; margin-bottom: 10px;">Shared With</h3>
            <div id="vaultMembersList" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;">
              <div class="empty-state" style="padding: 20px;">Loading members...</div>
            </div>
            <div class="form-group">
              <label for="addMemberUsername">Add Member (username):</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" id="addMemberUsername" placeholder="Enter username" style="flex: 1;" 
                       onkeypress="if(event.key === 'Enter') addVaultMember()" />
                <button onclick="addVaultMember()">Add</button>
              </div>
            </div>
            <div id="addMemberError" class="message error" style="display: none;"></div>
            
            <!-- Invite Code Display -->
            <div id="inviteCodeDisplay" class="invite-code-display">
                <h4>‚úÖ Member Added!</h4>
                <p>Share this Invite Code with the user so they can unlock the vault:</p>
                <div class="invite-code-container">
                    <code id="generatedInviteCode" class="invite-code-value"></code>
                    <button class="btn-small" onclick="copyInviteCode()">üìã Copy</button>
                </div>
                <p class="invite-code-helper">They will need to enter this code when they first access the vault.</p>
                <button class="secondary btn-small" onclick="document.getElementById('inviteCodeDisplay').style.display='none'" style="margin-top: 10px; width: 100%;">Done</button>
            </div>
          </div>

          <div id="vaultNotOwnedMessage" style="display: none; padding: 15px; background: #fff3cd; border-radius: 4px; color: #856404;">
            You are a member of this shared vault. Only the owner can manage members.
          </div>

          <div class="form-actions" style="margin-top: 20px;">
            <button class="secondary" onclick="hideManageVaultModal()">Close</button>
          </div>
        </div>
      </div>

      <!-- Authenticated Section -->
      <div id="authenticatedSection" class="hidden">
        <div class="user-info">
          <strong>Logged in as:</strong> <span id="currentUser"></span>
          <button class="secondary" onclick="lockApplication()" style="float: right; margin-right: 10px;">üîí Lock</button>
          <button class="danger" onclick="logout()" style="float: right;">Logout</button>
        </div>

        <h2>Vault Selection</h2>
        <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
          <div style="flex: 1;">
            <label for="vaultSelect">Select Vault:</label>
            <select id="vaultSelect" onchange="onVaultChange()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              <option value="">Loading vaults...</option>
            </select>
          </div>
          <button class="secondary" onclick="showCreateVaultModal()" style="margin: 0;">‚ûï New Vault</button>
          <button class="secondary" id="manageVaultBtn" onclick="showManageVaultModal()" style="margin: 0; display: none;">‚öôÔ∏è Manage</button>
        </div>

        <h2>Password Manager</h2>
        
        <div class="item-form">
          <h3>Add New Password</h3>
          <div class="form-group">
            <label for="itemWebsite">Website/Service:</label>
            <input type="text" id="itemWebsite" placeholder="e.g., github.com, gmail.com" />
          </div>
          <div class="form-group">
            <label for="itemUsername">Username/Email:</label>
            <input type="text" id="itemUsername" placeholder="Username or email address" />
          </div>
          <div class="form-group">
            <label for="itemPassword">Password:</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="password" id="itemPassword" placeholder="Enter password to encrypt" 
                     oninput="checkPasswordStrength()" style="flex: 1;" />
              <button type="button" class="btn-small" onclick="generateStrongPassword()" 
                      style="white-space: nowrap; background: #9C27B0;">
                üé≤ Generate
              </button>
            </div>
            <div id="passwordStrengthMeter" class="strength-meter">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <div id="strengthBar" class="strength-bar" style="flex: 1;">
                  <div id="strengthBarFill" class="strength-bar-fill"></div>
                </div>
                <span id="strengthText" class="strength-text"></span>
              </div>
              <div id="strengthFeedback" class="strength-feedback"></div>
            </div>
          </div>
          <div class="form-group">
            <label for="itemNotes">Notes (optional):</label>
            <textarea id="itemNotes" placeholder="Additional notes or information"></textarea>
          </div>
          <div class="form-actions">
            <button onclick="addItem()">‚ûï Add Password</button>
            <button class="secondary" onclick="clearForm()">Clear</button>
          </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
          <h2 style="margin: 0;">Saved Passwords</h2>
          <button class="secondary" onclick="loadItems()">üîÑ Refresh</button>
        </div>
        <div id="items"></div>
        
        <!-- Copy feedback -->
        <div id="copyFeedback" class="copy-feedback">‚úì Copied to clipboard!</div>
      </div>

      <!-- Debug Section -->
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
        <h2>Debug</h2>
        <button onclick="ping()">Ping Server</button>
        <pre id="resp"></pre>
      </div>
    </div>

    <script>
      const API_BASE = 'http://192.168.2.246:3000/api';

      // Master password stored in memory (never saved to localStorage)
      let masterPassword = null;
      let inactivityTimer = null;
      const INACTIVITY_TIMEOUT = 30 * 1000; // 30 seconds
      let isLocked = false;

      // Close modals when clicking outside
      window.onclick = function(event) {
        const modals = ['masterPasswordModal', 'createVaultModal', 'manageVaultModal', 'acceptInviteModal'];
        modals.forEach(modalId => {
          const modal = document.getElementById(modalId);
          if (event.target === modal) {
            if (modalId === 'masterPasswordModal') {
              // Don't close master password modal by clicking outside
              return;
            }
            modal.style.display = 'none';
          }
        });
      };

      // Check if user is already logged in
      window.onload = function() {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        if (token && user) {
          // User is logged in, but needs to enter master password
          const userObj = JSON.parse(user);
          document.getElementById('currentUser').textContent = userObj.username;
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('authenticatedSection').classList.remove('hidden');
          loadVaults();
          showMasterPasswordModal();
        }
        setupInactivityTracking();
      };

      // Setup inactivity tracking
      function setupInactivityTracking() {
        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
        events.forEach(event => {
          document.addEventListener(event, resetInactivityTimer, true);
        });
        resetInactivityTimer();
      }

      // Reset inactivity timer
      function resetInactivityTimer() {
        if (isLocked || !masterPassword) return;
        
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          if (masterPassword && !isLocked) {
            lockApplication();
          }
        }, INACTIVITY_TIMEOUT);
      }

      // Show master password modal
      function showMasterPasswordModal() {
        const modal = document.getElementById('masterPasswordModal');
        modal.style.display = 'block';
        document.getElementById('masterPasswordInput').focus();
      }

      // Hide master password modal
      function hideMasterPasswordModal() {
        const modal = document.getElementById('masterPasswordModal');
        modal.style.display = 'none';
        document.getElementById('masterPasswordInput').value = '';
        document.getElementById('masterPasswordError').style.display = 'none';
      }

      // Submit master password
      async function submitMasterPassword() {
        const password = document.getElementById('masterPasswordInput').value;
        if (!password) {
          document.getElementById('masterPasswordError').textContent = 'Master password is required';
          document.getElementById('masterPasswordError').style.display = 'block';
          return;
        }

        // Store master password (verification will happen when loading items)
        masterPassword = password;
        hideMasterPasswordModal();
        resetInactivityTimer();
        
        // Load items with decryption (this will verify the password if items exist)
        // If password is wrong, loadItems will show an error and lock the app
        await loadItems();
      }

      // Cancel master password entry
      function cancelMasterPassword() {
        hideMasterPasswordModal();
        logout();
      }

      // Lock application
      function lockApplication() {
        isLocked = true;
        masterPassword = null; // Clear from memory
        clearTimeout(inactivityTimer);
        
        // Clear all displayed passwords from the DOM
        document.getElementById('items').innerHTML = '<div class="empty-state">Please unlock the application to view items</div>';
        
        // Show locked overlay
        document.getElementById('lockedOverlay').classList.add('active');
        document.getElementById('unlockPasswordInput').focus();
      }

      // Unlock application
      async function unlockApplication() {
        const password = document.getElementById('unlockPasswordInput').value;
        if (!password) {
          document.getElementById('unlockError').textContent = 'Master password is required';
          document.getElementById('unlockError').style.display = 'block';
          return;
        }

        // Verify password by trying to load items
        masterPassword = password;
        try {
          const response = await authFetch(`${API_BASE}/items?vault_id=${currentVaultId || ''}&masterPassword=${encodeURIComponent(masterPassword)}`);
          const items = await response.json();
          
          // Check if there's a decryption error in any item
          if (response.ok) {
            const hasDecryptionError = items.some(item => item.decryptionError);
            if (hasDecryptionError) {
              document.getElementById('unlockError').textContent = 'Invalid master password';
              document.getElementById('unlockError').style.display = 'block';
              masterPassword = null;
              return;
            }
            
            // If successful, unlock
            isLocked = false;
            document.getElementById('lockedOverlay').classList.remove('active');
            document.getElementById('unlockPasswordInput').value = '';
            document.getElementById('unlockError').style.display = 'none';
            resetInactivityTimer();
            // Reload items to display them
            loadItems();
          } else {
            document.getElementById('unlockError').textContent = 'Invalid master password';
            document.getElementById('unlockError').style.display = 'block';
            masterPassword = null;
          }
        } catch (error) {
          document.getElementById('unlockError').textContent = 'Error verifying password: ' + error.message;
          document.getElementById('unlockError').style.display = 'block';
          masterPassword = null;
        }
      }

      // Get auth token from localStorage
      function getAuthToken() {
        return localStorage.getItem('token');
      }

      // Make authenticated request
      async function authFetch(url, options = {}) {
        const token = getAuthToken();
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers
        };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        const response = await fetch(url, {
          ...options,
          headers
        });

        if (response.status === 429) {
          const data = await response.json();
          console.log(data);
          throw new Error(data.error || 'Too many requests. Please try again later.');
        }

        return response;
      }

      // Show message
      function showMessage(message, type = 'success') {
        const msgEl = document.getElementById('authMessage');
        msgEl.textContent = message;
        msgEl.className = `message ${type}`;
        setTimeout(() => {
          msgEl.className = 'message';
        }, 5000);
      }

      // Register function
      async function register() {
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;

        if (!username || !password) {
          showMessage('Please fill in all fields', 'error');
          return;
        }

        if (password.length < 6) {
          showMessage('Password must be at least 6 characters', 'error');
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            showMessage('Registration successful!', 'success');
            showAuthenticated(data.user);
          } else {
            showMessage(data.error || 'Registration failed', 'error');
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Login function
      async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
          showMessage('Please fill in all fields', 'error');
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            showMessage('Login successful!', 'success');
            showAuthenticated(data.user);
            // Master password modal will be shown by showAuthenticated
          } else if (response.status === 429) {
            showMessage(data.error || 'Too many failed attempts. Please try again later.', 'error');
          } else {
            showMessage(data.error || 'Login failed', 'error');
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Logout function
      function logout() {
        // Clear master password from memory
        masterPassword = null;
        isLocked = false;
        clearTimeout(inactivityTimer);
        
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        currentVaultId = null;
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('authenticatedSection').classList.add('hidden');
        document.getElementById('lockedOverlay').classList.remove('active');
        document.getElementById('masterPasswordModal').style.display = 'none';
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
        showMessage('Logged out successfully', 'success');
      }

      // Current selected vault
      let currentVaultId = null;

      // Show authenticated UI
      function showAuthenticated(user) {
        document.getElementById('currentUser').textContent = user.username;
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('authenticatedSection').classList.remove('hidden');
        loadVaults();
        // Show master password modal after login
        showMasterPasswordModal();
      }

      // Show register form
      function showRegister() {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
      }

      // Show login form
      function showLogin() {
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
      }

      // Load vaults
      async function loadVaults() {
        try {
          const response = await authFetch(`${API_BASE}/vaults`);
          const vaults = await response.json();

          if (response.ok) {
            const select = document.getElementById('vaultSelect');
            select.innerHTML = '';
            
            if (vaults.length === 0) {
              select.innerHTML = '<option value="">No vaults available</option>';
              return;
            }

            vaults.forEach((vault) => {
              const option = document.createElement('option');
              option.value = vault.id;
              let displayName = vault.name;
              if (vault.is_shared) {
                  displayName = `üîó ${vault.name} (Shared)`;
              }
              if (vault.is_pending) {
                  displayName = `‚ö†Ô∏è ${vault.name} (Pending Invite)`;
              }
              option.textContent = displayName;
              option.dataset.ownerId = vault.owner_id;
              option.dataset.isShared = vault.is_shared || false;
              option.dataset.isPending = vault.is_pending || false;
              select.appendChild(option);
            });

            // Select the first vault (should be default vault) and load its items
            if (vaults.length > 0) {
              currentVaultId = vaults[0].id;
              select.value = currentVaultId;
              updateManageButton();
              loadItems();
            }
          } else {
            if (response.status === 401 || response.status === 403) {
              logout();
              showMessage('Session expired. Please login again.', 'error');
            } else {
              showMessage('Error loading vaults', 'error');
            }
          }
        } catch (error) {
          showMessage('Error loading vaults: ' + error.message, 'error');
        }
      }

      // Handle vault change
      function onVaultChange() {
        const select = document.getElementById('vaultSelect');
        currentVaultId = select.value ? parseInt(select.value) : null;
        
        const option = select.selectedOptions[0];
        if (option && option.dataset.isPending === 'true') {
            showAcceptInviteModal();
            return;
        }

        updateManageButton();
        loadItems();
        resetInactivityTimer();
      }

      // Show accept invite modal
      function showAcceptInviteModal() {
          document.getElementById('acceptInviteModal').style.display = 'block';
          document.getElementById('inviteCodeInput').value = '';
          document.getElementById('acceptInviteMasterPassword').value = '';
          document.getElementById('acceptInviteError').style.display = 'none';
          document.getElementById('inviteCodeInput').focus();
      }

      // Hide accept invite modal
      function hideAcceptInviteModal() {
          document.getElementById('acceptInviteModal').style.display = 'none';
          // Reset selection to default or empty if cancelled
          loadVaults(); 
      }

      // Accept invite
      async function acceptInvite() {
          const inviteCode = document.getElementById('inviteCodeInput').value.trim();
          const masterPass = document.getElementById('acceptInviteMasterPassword').value;

          if (!inviteCode || !masterPass) {
              document.getElementById('acceptInviteError').textContent = 'All fields are required';
              document.getElementById('acceptInviteError').style.display = 'block';
              return;
          }

          try {
              const response = await authFetch(`${API_BASE}/vaults/${currentVaultId}/accept-invite`, {
                  method: 'POST',
                  body: JSON.stringify({
                      inviteCode: inviteCode,
                      masterPassword: masterPass
                  })
              });

              const data = await response.json();

              if (response.ok) {
                  hideAcceptInviteModal();
                  showMessage('Invite accepted successfully!', 'success');
                  // Update master password in memory if it matches (likely does if they just entered it)
                  if (!masterPassword) {
                      masterPassword = masterPass;
                  }
                  loadVaults();
              } else {
                  document.getElementById('acceptInviteError').textContent = data.error || 'Failed to accept invite';
                  document.getElementById('acceptInviteError').style.display = 'block';
              }
          } catch (error) {
              document.getElementById('acceptInviteError').textContent = 'Error: ' + error.message;
              document.getElementById('acceptInviteError').style.display = 'block';
          }
      }

      // Update manage button visibility
      function updateManageButton() {
        const select = document.getElementById('vaultSelect');
        const manageBtn = document.getElementById('manageVaultBtn');
        if (currentVaultId && select.selectedOptions[0]) {
          const option = select.selectedOptions[0];
          manageBtn.style.display = 'inline-block';
        } else {
          manageBtn.style.display = 'none';
        }
      }

      // Show create vault modal
      function showCreateVaultModal() {
        if (isLocked || !masterPassword) {
          showMessage('Please unlock the application first', 'error');
          return;
        }
        document.getElementById('createVaultModal').style.display = 'block';
        document.getElementById('newVaultName').value = '';
        document.getElementById('createVaultMasterPassword').value = '';
        document.getElementById('createVaultError').style.display = 'none';
        document.getElementById('newVaultName').focus();
      }

      // Hide create vault modal
      function hideCreateVaultModal() {
        document.getElementById('createVaultModal').style.display = 'none';
        document.getElementById('newVaultName').value = '';
        document.getElementById('createVaultMasterPassword').value = '';
        document.getElementById('createVaultError').style.display = 'none';
      }

      // Create vault
      async function createVault() {
        const name = document.getElementById('newVaultName').value.trim();
        const vaultMasterPassword = document.getElementById('createVaultMasterPassword').value;

        if (!name) {
          document.getElementById('createVaultError').textContent = 'Vault name is required';
          document.getElementById('createVaultError').style.display = 'block';
          return;
        }

        if (!vaultMasterPassword) {
          document.getElementById('createVaultError').textContent = 'Master password is required';
          document.getElementById('createVaultError').style.display = 'block';
          return;
        }

        try {
          const response = await authFetch(`${API_BASE}/vaults`, {
            method: 'POST',
            body: JSON.stringify({
              name: name,
              masterPassword: vaultMasterPassword
            })
          });

          const data = await response.json();

          if (response.ok) {
            hideCreateVaultModal();
            showMessage('Vault created successfully!', 'success');
            loadVaults();
          } else {
            document.getElementById('createVaultError').textContent = data.error || 'Failed to create vault';
            document.getElementById('createVaultError').style.display = 'block';
          }
        } catch (error) {
          document.getElementById('createVaultError').textContent = 'Error: ' + error.message;
          document.getElementById('createVaultError').style.display = 'block';
        }
      }

      // Show manage vault modal
      async function showManageVaultModal() {
        if (!currentVaultId) return;

        const select = document.getElementById('vaultSelect');
        const option = select.selectedOptions[0];
        if (!option) return;

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const currentUserId = user.id;

        const vaultName = option.textContent.replace('üîó ', '').replace(' (Shared)', '');
        const isOwner = parseInt(option.dataset.ownerId) === parseInt(currentUserId);
        const isShared = option.dataset.isShared === 'true';

        document.getElementById('managedVaultName').textContent = vaultName;
        document.getElementById('managedVaultType').textContent = isShared ? 'Shared Vault' : 'Personal Vault';
        document.getElementById('vaultMembersSection').style.display = isOwner ? 'block' : 'none';
        document.getElementById('vaultNotOwnedMessage').style.display = !isOwner && isShared ? 'block' : 'none';

        document.getElementById('manageVaultModal').style.display = 'block';
        document.getElementById('addMemberUsername').value = '';
        document.getElementById('addMemberError').style.display = 'none';

        if (isOwner) {
          await loadVaultMembers();
        }
      }

      // Hide manage vault modal
      function hideManageVaultModal() {
        document.getElementById('manageVaultModal').style.display = 'none';
      }

      // Load vault members
      async function loadVaultMembers() {
        if (!currentVaultId) return;

        try {
          const response = await authFetch(`${API_BASE}/vaults/${currentVaultId}/members`);
          const members = await response.json();

          if (response.ok) {
            const membersList = document.getElementById('vaultMembersList');
            if (members.length === 0) {
              membersList.innerHTML = '<div class="empty-state" style="padding: 20px;">No members yet. Add members below.</div>';
            } else {
              membersList.innerHTML = members.map(member => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px;">
                  <div>
                    <strong>${escapeHtml(member.username)}</strong>
                    <div style="font-size: 12px; color: #666;">Added ${new Date(member.created_at).toLocaleDateString()}</div>
                  </div>
                  <button class="danger btn-small" onclick="removeVaultMember(${member.id}, '${escapeHtml(member.username)}')">Remove</button>
                </div>
              `).join('');
            }
          } else {
            document.getElementById('vaultMembersList').innerHTML = '<div class="empty-state" style="padding: 20px; color: red;">Error loading members</div>';
          }
        } catch (error) {
          document.getElementById('vaultMembersList').innerHTML = '<div class="empty-state" style="padding: 20px; color: red;">Error: ' + error.message + '</div>';
        }
      }

      // Add vault member
      async function addVaultMember() {
        const username = document.getElementById('addMemberUsername').value.trim();
        if (!username) {
          document.getElementById('addMemberError').textContent = 'Username is required';
          document.getElementById('addMemberError').style.display = 'block';
          return;
        }

        if (!masterPassword) {
          document.getElementById('addMemberError').textContent = 'Please unlock the application first';
          document.getElementById('addMemberError').style.display = 'block';
          return;
        }

        try {
          const response = await authFetch(`${API_BASE}/vaults/${currentVaultId}/members`, {
            method: 'POST',
            body: JSON.stringify({
              username: username,
              ownerMasterPassword: masterPassword
            })
          });

          const data = await response.json();

          if (response.ok) {
            document.getElementById('addMemberUsername').value = '';
            document.getElementById('addMemberError').style.display = 'none';
            
            // Show invite code
            if (data.inviteCode) {
                document.getElementById('generatedInviteCode').textContent = data.inviteCode;
                document.getElementById('inviteCodeDisplay').style.display = 'block';
            } else {
                showMessage(data.message || 'Member added successfully.', 'success');
            }
            
            await loadVaultMembers();
            loadVaults();
          } else {
            document.getElementById('addMemberError').textContent = data.error || 'Failed to add member';
            document.getElementById('addMemberError').style.display = 'block';
          }
        } catch (error) {
          document.getElementById('addMemberError').textContent = 'Error: ' + error.message;
          document.getElementById('addMemberError').style.display = 'block';
        }
      }

      // Remove vault member
      async function removeVaultMember(userId, username) {
        if (!confirm(`Are you sure you want to remove ${username} from this vault?`)) {
          return;
        }

        try {
          const response = await authFetch(`${API_BASE}/vaults/${currentVaultId}/members/${userId}`, {
            method: 'DELETE'
          });

          const data = await response.json();

          if (response.ok) {
            await loadVaultMembers();
            showMessage('Member removed successfully', 'success');
          } else {
            showMessage(data.error || 'Failed to remove member', 'error');
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      function copyInviteCode() {
          const code = document.getElementById('generatedInviteCode').textContent;
          navigator.clipboard.writeText(code).then(() => {
              const btn = document.querySelector('#inviteCodeDisplay button:nth-of-type(1)'); // Copy button
              const originalText = btn.textContent;
              btn.textContent = '‚úì Copied!';
              setTimeout(() => btn.textContent = originalText, 2000);
          });
      }


      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Parse item description to extract username and notes
      function parseItemDescription(description) {
        if (!description) return { username: '', notes: '' };
        
        // Try to parse structured format: "Username: xxx | Notes: yyy"
        const usernameMatch = description.match(/Username:\s*(.+?)(?:\s*\||$)/i);
        const notesMatch = description.match(/Notes:\s*(.+?)$/i);
        
        if (usernameMatch || notesMatch) {
          return {
            username: usernameMatch ? usernameMatch[1].trim() : '',
            notes: notesMatch ? notesMatch[1].trim() : ''
          };
        }
        
        // Fallback: treat entire description as notes if no structure found
        return { username: '', notes: description };
      }

      // Format item description from username and notes
      function formatItemDescription(username, notes) {
        const parts = [];
        if (username) parts.push(`Username: ${username}`);
        if (notes) parts.push(`Notes: ${notes}`);
        return parts.join(' | ') || '';
      }

      // Load items
      async function loadItems() {
        if (!currentVaultId) {
          document.getElementById('items').innerHTML = '<div class="empty-state">Please select a vault</div>';
          return;
        }

        if (isLocked || !masterPassword) {
          document.getElementById('items').innerHTML = '<div class="empty-state">Please unlock the application to view items</div>';
          return;
        }

        try {
          // Include master password in query for decryption
          const response = await authFetch(`${API_BASE}/items?vault_id=${currentVaultId}&masterPassword=${encodeURIComponent(masterPassword)}`);
          const items = await response.json();

          if (response.ok) {
            const container = document.getElementById('items');
            container.innerHTML = '';
            
            if (items.length === 0) {
              container.innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">üîí</div>
                  <div>No passwords saved yet</div>
                  <div style="margin-top: 10px; font-size: 14px;">Add your first password above</div>
                </div>
              `;
            } else {
              items.forEach((item) => {
                const { username, notes } = parseItemDescription(item.description);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'password-item';
                itemDiv.id = `item-${item.id}`;
                
                const passwordId = `pwd-${item.id}`;
                const hasPassword = item.password && !item.decryptionError;
                const passwordValue = item.password || '';
                const escapedPassword = passwordValue.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                const escapedName = escapeHtml(item.name || 'Untitled');
                const escapedUsername = escapeHtml(username);
                const escapedNotes = escapeHtml(notes);
                const escapedError = item.decryptionError ? escapeHtml(item.decryptionError) : '';
                
                itemDiv.innerHTML = `
                  <div class="password-item-header" onclick="toggleItemDetails(${item.id})">
                    <div class="password-item-title">${escapedName}</div>
                    <button class="danger btn-small" onclick="event.stopPropagation(); deleteItem(${item.id})">üóëÔ∏è Delete</button>
                  </div>
                  <div class="password-item-details" id="details-${item.id}">
                    ${username ? `
                      <div class="password-field">
                        <div class="password-field-label">Username/Email</div>
                        <div class="password-field-value">${escapedUsername}</div>
                      </div>
                    ` : ''}
                    ${hasPassword ? `
                      <div class="password-field">
                        <div class="password-field-label">Password</div>
                        <div class="password-field-value password-hidden" id="${passwordId}" data-password="${escapedPassword}">${'‚Ä¢'.repeat(20)}</div>
                        <div class="password-actions">
                          <button class="btn-small btn-show" onclick="togglePassword('${passwordId}')">üëÅÔ∏è Show</button>
                          <button class="btn-small btn-copy" onclick="copyPassword('${passwordId}')">üìã Copy</button>
                        </div>
                      </div>
                    ` : item.decryptionError ? `
                      <div class="password-field">
                        <div style="color: red; font-size: 12px; padding: 8px; background: #ffebee; border-radius: 4px;">
                          ${escapedError}
                        </div>
                      </div>
                    ` : ''}
                    ${notes ? `
                      <div class="password-field">
                        <div class="password-field-label">Notes</div>
                        <div class="password-field-value" style="white-space: pre-wrap;">${escapedNotes}</div>
                      </div>
                    ` : ''}
                  </div>
                `;
                container.appendChild(itemDiv);
              });
            }
            
            // Check if any items have decryption errors (invalid master password)
            const hasDecryptionError = items.some(item => item.decryptionError);
            if (hasDecryptionError) {
              showMessage('Invalid master password. Please unlock again.', 'error');
              lockApplication();
              return;
            }
            
            resetInactivityTimer();
          } else {
            if (response.status === 401 || response.status === 403) {
              logout();
              showMessage('Session expired. Please login again.', 'error');
            } else {
              // Check if it's a decryption error
              if (items.error && items.error.includes('decrypt')) {
                showMessage('Invalid master password. Please unlock again.', 'error');
                lockApplication();
              } else {
                showMessage(items.error || 'Error loading items', 'error');
              }
            }
          }
        } catch (error) {
          showMessage('Error loading items: ' + error.message, 'error');
        }
      }

      // Toggle item details (expand/collapse)
      function toggleItemDetails(itemId) {
        const header = document.querySelector(`#item-${itemId} .password-item-header`);
        const details = document.getElementById(`details-${itemId}`);
        
        if (details.classList.contains('expanded')) {
          details.classList.remove('expanded');
          header.classList.remove('expanded');
        } else {
          // Close all other items
          document.querySelectorAll('.password-item-details.expanded').forEach(el => {
            el.classList.remove('expanded');
            el.closest('.password-item').querySelector('.password-item-header').classList.remove('expanded');
          });
          
          details.classList.add('expanded');
          header.classList.add('expanded');
        }
        resetInactivityTimer();
      }

      // Toggle password visibility
      function togglePassword(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const password = element.getAttribute('data-password');
        const button = element.parentElement.querySelector('.btn-show');
        
        if (element.textContent.includes('‚Ä¢')) {
          // Show password (it's already decrypted from server)
          element.textContent = password;
          element.classList.remove('password-hidden');
          if (button) button.textContent = 'üôà Hide';
        } else {
          // Hide password
          element.textContent = '‚Ä¢'.repeat(20);
          element.classList.add('password-hidden');
          if (button) button.textContent = 'üëÅÔ∏è Show';
        }
        resetInactivityTimer();
      }

      // Copy password to clipboard
      async function copyPassword(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const password = element.getAttribute('data-password');
        if (!password) return;
        
        try {
          // Use secure clipboard manager with auto-clear
          if (window.clipboardManager) {
            await window.clipboardManager.copyWithAutoClear(password);
          } else {
            // Fallback if manager not loaded (shouldn't happen)
            await navigator.clipboard.writeText(password);
          }
          
          // Show feedback
          const feedback = document.getElementById('copyFeedback');
          feedback.textContent = '‚úì Copied! Will clear in 30s';
          feedback.classList.add('show');
          setTimeout(() => {
            feedback.classList.remove('show');
          }, 2000);
          
          resetInactivityTimer();
        } catch (error) {
          showMessage('Failed to copy password: ' + error.message, 'error');
        }
      }

      // Clear form
      function clearForm() {
        document.getElementById('itemWebsite').value = '';
        document.getElementById('itemUsername').value = '';
        document.getElementById('itemPassword').value = '';
        document.getElementById('itemNotes').value = '';
        document.getElementById('passwordStrengthMeter').style.display = 'none';
      }

      // Check password strength using zxcvbn or custom checker
      function checkPasswordStrength() {
        const password = document.getElementById('itemPassword').value;
        const meter = document.getElementById('passwordStrengthMeter');
        const barFill = document.getElementById('strengthBarFill');
        const strengthText = document.getElementById('strengthText');
        const strengthFeedback = document.getElementById('strengthFeedback');

        if (!password) {
          meter.style.display = 'none';
          return;
        }

        meter.style.display = 'block';

        let strength, score, feedbackText;

        // Use zxcvbn if available, otherwise use custom checker
        if (typeof zxcvbn !== 'undefined') {
          const result = zxcvbn(password);
          score = result.score; // 0-4
          strength = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'][score];
          feedbackText = result.feedback.suggestions.length > 0 
            ? result.feedback.suggestions[0] 
            : result.feedback.warning || '';
        } else {
          // Custom strength checker
          const result = calculatePasswordStrength(password);
          score = result.score;
          strength = result.strength;
          feedbackText = result.feedback;
        }

        // Update visual indicator
        const percentage = (score + 1) * 20; // 0-4 -> 20%, 40%, 60%, 80%, 100%
        barFill.style.width = percentage + '%';
        
        // Remove all strength classes
        barFill.className = '';
        strengthText.className = '';
        
        // Add appropriate class based on score
        const strengthClasses = ['strength-very-weak', 'strength-weak', 'strength-fair', 'strength-good', 'strength-strong'];
        const textClasses = ['strength-text-very-weak', 'strength-text-weak', 'strength-text-fair', 'strength-text-good', 'strength-text-strong'];
        
        barFill.classList.add(strengthClasses[score]);
        strengthText.classList.add(textClasses[score]);
        strengthText.textContent = strength;
        strengthFeedback.textContent = feedbackText || '';

        resetInactivityTimer();
      }

      // Custom password strength calculator (fallback if zxcvbn not available)
      function calculatePasswordStrength(password) {
        let score = 0;
        let feedback = '';

        if (password.length === 0) {
          return { score: 0, strength: 'Very Weak', feedback: '' };
        }

        // Length checks
        if (password.length >= 8) score++;
        if (password.length >= 12) score++;
        if (password.length >= 16) score++;

        // Character variety checks
        const hasLower = /[a-z]/.test(password);
        const hasUpper = /[A-Z]/.test(password);
        const hasNumbers = /[0-9]/.test(password);
        const hasSpecial = /[^a-zA-Z0-9]/.test(password);

        if (hasLower) score++;
        if (hasUpper) score++;
        if (hasNumbers) score++;
        if (hasSpecial) score++;

        // Common patterns (penalize)
        const commonPatterns = [
          /12345/, /password/i, /qwerty/i, /abc123/i,
          /letmein/i, /welcome/i, /admin/i, /12345678/
        ];
        
        if (commonPatterns.some(pattern => pattern.test(password))) {
          score = Math.max(0, score - 2);
        }

        // Cap score at 4
        score = Math.min(4, score);

        // Determine strength and feedback
        let strength, feedbackText;
        if (score === 0) {
          strength = 'Very Weak';
          feedbackText = 'Use at least 8 characters';
        } else if (score === 1) {
          strength = 'Weak';
          feedbackText = 'Add uppercase letters and numbers';
        } else if (score === 2) {
          strength = 'Fair';
          feedbackText = 'Add special characters for better security';
        } else if (score === 3) {
          strength = 'Good';
          feedbackText = 'Strong password! Consider making it longer';
        } else {
          strength = 'Strong';
          feedbackText = 'Excellent password strength!';
        }

        // Additional feedback
        if (password.length < 8) {
          feedbackText = 'Use at least 8 characters';
        } else if (!hasLower || !hasUpper) {
          feedbackText = 'Mix uppercase and lowercase letters';
        } else if (!hasNumbers) {
          feedbackText = 'Add numbers';
        } else if (!hasSpecial) {
          feedbackText = 'Add special characters (!@#$%^&*)';
        }

        return { score, strength, feedback: feedbackText };
      }

      // Generate strong password
      function generateStrongPassword() {
        const length = 16; // Default length
        const includeUppercase = true;
        const includeLowercase = true;
        const includeNumbers = true;
        const includeSpecial = true;

        const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const lowercase = 'abcdefghijklmnopqrstuvwxyz';
        const numbers = '0123456789';
        const special = '!@#$%^&*()_+-=[]{}|;:,.<>?';

        let charset = '';
        if (includeLowercase) charset += lowercase;
        if (includeUppercase) charset += uppercase;
        if (includeNumbers) charset += numbers;
        if (includeSpecial) charset += special;

        // Ensure at least one character from each category
        let passwordChars = [];
        if (includeLowercase) passwordChars.push(lowercase[Math.floor(Math.random() * lowercase.length)]);
        if (includeUppercase) passwordChars.push(uppercase[Math.floor(Math.random() * uppercase.length)]);
        if (includeNumbers) passwordChars.push(numbers[Math.floor(Math.random() * numbers.length)]);
        if (includeSpecial) passwordChars.push(special[Math.floor(Math.random() * special.length)]);

        // Fill the rest randomly using crypto.getRandomValues
        const remainingLength = length - passwordChars.length;
        const randomValues = new Uint32Array(remainingLength);
        window.crypto.getRandomValues(randomValues);
        
        for (let i = 0; i < remainingLength; i++) {
          passwordChars.push(charset[randomValues[i] % charset.length]);
        }

        // Shuffle the password using crypto
        const shuffleValues = new Uint32Array(passwordChars.length);
        window.crypto.getRandomValues(shuffleValues);
        
        // Fisher-Yates shuffle
        for (let i = passwordChars.length - 1; i > 0; i--) {
          const j = shuffleValues[i] % (i + 1);
          [passwordChars[i], passwordChars[j]] = [passwordChars[j], passwordChars[i]];
        }
        
        let password = passwordChars.join('');

        // Set password and trigger strength check
        const passwordInput = document.getElementById('itemPassword');
        passwordInput.type = 'text'; // Show generated password briefly
        passwordInput.value = password;
        checkPasswordStrength();
        
        // Hide password after 3 seconds
        setTimeout(() => {
          passwordInput.type = 'password';
        }, 3000);
      }

      // Theme toggler
      function toggleTheme() {
          const themes = ["light", "dark", "cyan", "forest", "premium"];
          const current = document.body.getAttribute("data-theme") || "light";
          const next = themes[(themes.indexOf(current) + 1) % themes.length];
          document.body.setAttribute("data-theme", next);
          localStorage.setItem("theme", next);
          updateThemeIcon(next);
      }

      function updateThemeIcon(theme) {
          const icon = document.getElementById("themeIcon");
          const map = {
              light: "üåô",
              dark: "‚òÄÔ∏è",
              cyan: "üí†",
              forest: "üåø",
              premium: "üíé"
          };
          icon.textContent = map[theme] || "üåô";
      }

      // Initialize theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);



      // Add item
      async function addItem() {
        if (isLocked || !masterPassword) {
          showMessage('Please unlock the application first', 'error');
          return;
        }

        const website = document.getElementById('itemWebsite').value.trim();
        const username = document.getElementById('itemUsername').value.trim();
        const password = document.getElementById('itemPassword').value;
        const notes = document.getElementById('itemNotes').value.trim();

        if (!website) {
          showMessage('Website/Service name is required', 'error');
          return;
        }

        if (!currentVaultId) {
          showMessage('Please select a vault first', 'error');
          return;
        }

        // Format description with username and notes
        const description = formatItemDescription(username, notes);

        try {
          const response = await authFetch(`${API_BASE}/items`, {
            method: 'POST',
            body: JSON.stringify({ 
              name: website, 
              description: description, 
              password: password || undefined,
              masterPassword: password ? masterPassword : undefined,
              vault_id: currentVaultId 
            })
          });

          const data = await response.json();

          if (response.ok) {
            clearForm();
            loadItems();
            showMessage('Password saved successfully!', 'success');
            resetInactivityTimer();
          } else {
            if (response.status === 401 || response.status === 403) {
              logout();
              showMessage('Session expired. Please login again.', 'error');
            } else {
              showMessage(data.error || 'Failed to add password', 'error');
            }
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Delete item
      async function deleteItem(id) {
        if (!confirm('Are you sure you want to delete this item?')) {
          return;
        }

        try {
          const response = await authFetch(`${API_BASE}/items/${id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            loadItems();
            showMessage('Item deleted successfully!', 'success');
            resetInactivityTimer();
          } else {
            if (response.status === 401 || response.status === 403) {
              logout();
              showMessage('Session expired. Please login again.', 'error');
            } else {
              const data = await response.json();
              showMessage(data.error || 'Failed to delete item', 'error');
            }
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Ping function
      function ping() {
        fetch(`${API_BASE}/ping`)
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("resp").innerText = JSON.stringify(data, null, 2);
          })
          .catch((err) => {
            document.getElementById("resp").innerText = "Error: " + err;
          });
      }
    </script>
  </body>
</html>
