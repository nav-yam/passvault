<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Electron Client UI</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      h1 {
        margin-bottom: 20px;
        color: #333;
      }
      h2 {
        margin-top: 30px;
        margin-bottom: 15px;
        color: #555;
      }
      .auth-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 6px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }
      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      input:focus {
        outline: none;
        border-color: #4CAF50;
      }
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }
      select:focus {
        outline: none;
        border-color: #4CAF50;
      }
      button {
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
        margin-top: 5px;
      }
      button:hover {
        background: #45a049;
      }
      button.secondary {
        background: #2196F3;
      }
      button.secondary:hover {
        background: #0b7dda;
      }
      button.danger {
        background: #f44336;
      }
      button.danger:hover {
        background: #da190b;
      }
      .message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        display: none;
      }
      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }
      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }
      .user-info {
        padding: 10px;
        background: #e3f2fd;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .hidden {
        display: none;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        padding: 10px;
        background: #f9f9f9;
        margin-bottom: 5px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .item-form {
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 6px;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      /* Master Password Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }
      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        position: relative;
      }
      .modal-content:hover {
        cursor: default;
      }
      .modal-content h2 {
        margin-top: 0;
        margin-bottom: 20px;
      }
      .locked-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .locked-overlay.active {
        display: flex;
      }
      .locked-content {
        background: white;
        padding: 40px;
        border-radius: 8px;
        text-align: center;
        max-width: 400px;
      }
      .locked-content h2 {
        margin-top: 0;
        color: #333;
      }
      .password-display {
        font-family: monospace;
        background: #f5f5f5;
        padding: 8px;
        border-radius: 4px;
        margin: 5px 0;
        word-break: break-all;
      }
      .password-toggle {
        cursor: pointer;
        color: #2196F3;
        font-size: 12px;
        margin-left: 10px;
      }
      .password-toggle:hover {
        text-decoration: underline;
      }
      /* Improved Password Item Styles */
      .password-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
        transition: box-shadow 0.2s;
      }
      .password-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .password-item-header {
        padding: 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fafafa;
        border-bottom: 1px solid #e0e0e0;
      }
      .password-item-header:hover {
        background: #f5f5f5;
      }
      .password-item-header.expanded {
        border-bottom: 2px solid #4CAF50;
      }
      .password-item-title {
        font-weight: 600;
        font-size: 16px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .password-item-title::before {
        content: '‚ñ∂';
        font-size: 12px;
        transition: transform 0.2s;
        color: #999;
      }
      .password-item-header.expanded .password-item-title::before {
        transform: rotate(90deg);
      }
      .password-item-details {
        padding: 0 15px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, padding 0.3s ease-out;
      }
      .password-item-details.expanded {
        max-height: 500px;
        padding: 15px;
      }
      .password-field {
        margin-bottom: 15px;
      }
      .password-field-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
        font-weight: 600;
      }
      .password-field-value {
        font-size: 14px;
        color: #333;
        word-break: break-all;
        padding: 8px;
        background: #f9f9f9;
        border-radius: 4px;
        font-family: monospace;
      }
      .password-field-value.password-hidden {
        font-family: monospace;
        letter-spacing: 2px;
      }
      .password-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        margin: 0;
      }
      .btn-copy {
        background: #2196F3;
        color: white;
      }
      .btn-copy:hover {
        background: #0b7dda;
      }
      .btn-show {
        background: #9C27B0;
        color: white;
      }
      .btn-show:hover {
        background: #7b1fa2;
      }
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        min-height: 60px;
      }
      textarea:focus {
        outline: none;
        border-color: #4CAF50;
      }
      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .copy-feedback {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 3000;
        display: none;
        animation: slideIn 0.3s ease-out;
      }
      .copy-feedback.show {
        display: block;
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }
      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }
      /* Password Strength Meter */
      .strength-very-weak { background: #f44336 !important; }
      .strength-weak { background: #ff9800 !important; }
      .strength-fair { background: #ffc107 !important; }
      .strength-good { background: #8bc34a !important; }
      .strength-strong { background: #4caf50 !important; }
      .strength-text-very-weak { color: #f44336 !important; }
      .strength-text-weak { color: #ff9800 !important; }
      .strength-text-fair { color: #ffc107 !important; }
      .strength-text-good { color: #8bc34a !important; }
      .strength-text-strong { color: #4caf50 !important; }
    </style>
    <!-- zxcvbn for password strength checking -->
    <script src="https://cdn.jsdelivr.net/npm/zxcvbn@4.4.2/dist/zxcvbn.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>üîí Secure App</h1>

      <!-- Authentication Section -->
      <div class="auth-section" id="authSection">
        <h2>Authentication</h2>
        <div id="authMessage" class="message"></div>
        
        <!-- Login Form -->
        <div id="loginForm">
          <h3>Login</h3>
          <div class="form-group">
            <label for="loginUsername">Username:</label>
            <input type="text" id="loginUsername" placeholder="Enter username" />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter password" />
          </div>
          <button onclick="login()">Login</button>
          <button class="secondary" onclick="showRegister()">Switch to Register</button>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="hidden">
          <h3>Register</h3>
          <div class="form-group">
            <label for="registerUsername">Username:</label>
            <input type="text" id="registerUsername" placeholder="Enter username" />
          </div>
          <div class="form-group">
            <label for="registerPassword">Password:</label>
            <input type="password" id="registerPassword" placeholder="Enter password (min 6 characters)" />
          </div>
          <button onclick="register()">Register</button>
          <button class="secondary" onclick="showLogin()">Switch to Login</button>
        </div>
      </div>

      <!-- Master Password Modal -->
      <div id="masterPasswordModal" class="modal">
        <div class="modal-content">
          <h2>üîê Enter Master Password</h2>
          <p style="margin-bottom: 20px; color: #666;">Your master password is used to encrypt and decrypt your entries. It is never saved and only stored in memory for this session.</p>
          <div class="form-group">
            <label for="masterPasswordInput">Master Password:</label>
            <input type="password" id="masterPasswordInput" placeholder="Enter master password" autofocus 
                   onkeypress="if(event.key === 'Enter') submitMasterPassword()" />
          </div>
          <div id="masterPasswordError" class="message error" style="display: none;"></div>
          <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
            <button onclick="submitMasterPassword()">Unlock</button>
            <button class="danger" onclick="logout()">Logout</button>
          </div>
          <p style="margin-top: 15px; font-size: 12px; color: #999;">Press Enter to submit</p>
        </div>
      </div>

      <!-- Locked Overlay -->
      <div id="lockedOverlay" class="locked-overlay">
        <div class="locked-content">
          <h2>üîí Application Locked</h2>
          <p style="margin-bottom: 20px; color: #666;">The application has been locked due to inactivity. Please enter your master password to continue.</p>
          <div class="form-group">
            <label for="unlockPasswordInput">Master Password:</label>
            <input type="password" id="unlockPasswordInput" placeholder="Enter master password" autofocus 
                   onkeypress="if(event.key === 'Enter') unlockApplication()" />
          </div>
          <div id="unlockError" class="message error" style="display: none;"></div>
          <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
            <button onclick="unlockApplication()">Unlock</button>
            <button class="danger" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>

      <!-- Create Vault Modal -->
      <div id="createVaultModal" class="modal">
        <div class="modal-content">
          <h2>‚ûï Create New Vault</h2>
          <div class="form-group">
            <label for="newVaultName">Vault Name:</label>
            <input type="text" id="newVaultName" placeholder="Enter vault name" autofocus 
                   onkeypress="if(event.key === 'Enter') createVault()" />
          </div>
          <div class="form-group">
            <label for="createVaultMasterPassword">Master Password:</label>
            <input type="password" id="createVaultMasterPassword" placeholder="Enter your master password" 
                   onkeypress="if(event.key === 'Enter') createVault()" />
          </div>
          <div id="createVaultError" class="message error" style="display: none;"></div>
          <div class="form-actions">
            <button onclick="createVault()">Create</button>
            <button class="secondary" onclick="hideCreateVaultModal()">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Manage Vault Modal -->
      <div id="manageVaultModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
          <h2>‚öôÔ∏è Manage Vault</h2>
          <div id="vaultInfo" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 4px;">
            <strong>Vault:</strong> <span id="managedVaultName"></span><br>
            <strong>Type:</strong> <span id="managedVaultType"></span>
          </div>

          <div id="vaultMembersSection" style="display: none;">
            <h3 style="margin-top: 20px; margin-bottom: 10px;">Shared With</h3>
            <div id="vaultMembersList" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;">
              <div class="empty-state" style="padding: 20px;">Loading members...</div>
            </div>
            <div class="form-group">
              <label for="addMemberUsername">Add Member (username):</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" id="addMemberUsername" placeholder="Enter username" style="flex: 1;" 
                       onkeypress="if(event.key === 'Enter') addVaultMember()" />
                <button onclick="addVaultMember()">Add</button>
              </div>
            </div>
            <div id="addMemberError" class="message error" style="display: none;"></div>
          </div>

          <div id="vaultNotOwnedMessage" style="display: none; padding: 15px; background: #fff3cd; border-radius: 4px; color: #856404;">
            You are a member of this shared vault. Only the owner can manage members.
          </div>

          <div class="form-actions" style="margin-top: 20px;">
            <button class="secondary" onclick="hideManageVaultModal()">Close</button>
          </div>
        </div>
      </div>

      <!-- Authenticated Section -->
      <div id="authenticatedSection" class="hidden">
        <div class="user-info">
          <strong>Logged in as:</strong> <span id="currentUser"></span>
          <button class="secondary" onclick="lockApplication()" style="float: right; margin-right: 10px;">üîí Lock</button>
          <button class="danger" onclick="logout()" style="float: right;">Logout</button>
        </div>

        <h2>Vault Selection</h2>
        <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
          <div style="flex: 1;">
            <label for="vaultSelect">Select Vault:</label>
            <select id="vaultSelect" onchange="onVaultChange()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              <option value="">Loading vaults...</option>
            </select>
          </div>
          <button class="secondary" onclick="showCreateVaultModal()" style="margin: 0;">‚ûï New Vault</button>
          <button class="secondary" id="manageVaultBtn" onclick="showManageVaultModal()" style="margin: 0; display: none;">‚öôÔ∏è Manage</button>
        </div>

        <h2>Password Manager</h2>
        
        <div class="item-form">
          <h3>Add New Password</h3>
          <div class="form-group">
            <label for="itemWebsite">Website/Service:</label>
            <input type="text" id="itemWebsite" placeholder="e.g., github.com, gmail.com" />
          </div>
          <div class="form-group">
            <label for="itemUsername">Username/Email:</label>
            <input type="text" id="itemUsername" placeholder="Username or email address" />
          </div>
          <div class="form-group">
            <label for="itemPassword">Password:</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="password" id="itemPassword" placeholder="Enter password to encrypt" 
                     oninput="checkPasswordStrength()" style="flex: 1;" />
              <button type="button" class="btn-small" onclick="generateStrongPassword()" 
                      style="white-space: nowrap; background: #9C27B0;">
                üé≤ Generate
              </button>
            </div>
            <div id="passwordStrengthMeter" style="margin-top: 8px; display: none;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <div id="strengthBar" style="flex: 1; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                  <div id="strengthBarFill" style="height: 100%; width: 0%; transition: all 0.3s; border-radius: 3px;"></div>
                </div>
                <span id="strengthText" style="font-size: 12px; font-weight: 600; min-width: 80px; text-align: right;"></span>
              </div>
              <div id="strengthFeedback" style="font-size: 11px; color: #666; margin-top: 4px;"></div>
            </div>
          </div>
          <div class="form-group">
            <label for="itemNotes">Notes (optional):</label>
            <textarea id="itemNotes" placeholder="Additional notes or information"></textarea>
          </div>
          <div class="form-actions">
            <button onclick="addItem()">‚ûï Add Password</button>
            <button class="secondary" onclick="clearForm()">Clear</button>
          </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
          <h2 style="margin: 0;">Saved Passwords</h2>
          <button class="secondary" onclick="loadItems()">üîÑ Refresh</button>
        </div>
        <div id="items"></div>
        
        <!-- Copy feedback -->
        <div id="copyFeedback" class="copy-feedback">‚úì Copied to clipboard!</div>
      </div>

      <!-- Debug Section -->
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
        <h2>Debug</h2>
        <button onclick="ping()">Ping Server</button>
        <pre id="resp"></pre>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:3000/api';

      // Master password stored in memory (never saved to localStorage)
      let masterPassword = null;
      let inactivityTimer = null;
      const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds
      let isLocked = false;

      // Close modals when clicking outside
      window.onclick = function(event) {
        const modals = ['masterPasswordModal', 'createVaultModal', 'manageVaultModal'];
        modals.forEach(modalId => {
          const modal = document.getElementById(modalId);
          if (event.target === modal) {
            if (modalId === 'masterPasswordModal') {
              // Don't close master password modal by clicking outside
              return;
            }
            modal.style.display = 'none';
          }
        });
      };

      // Check if user is already logged in
      window.onload = function() {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        if (token && user) {
          // User is logged in, but needs to enter master password
          const userObj = JSON.parse(user);
          document.getElementById('currentUser').textContent = userObj.username;
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('authenticatedSection').classList.remove('hidden');
          loadVaults();
          showMasterPasswordModal();
        }
        setupInactivityTracking();
      };

      // Setup inactivity tracking
      function setupInactivityTracking() {
        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
        events.forEach(event => {
          document.addEventListener(event, resetInactivityTimer, true);
        });
        resetInactivityTimer();
      }

      // Reset inactivity timer
      function resetInactivityTimer() {
        if (isLocked || !masterPassword) return;
        
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          if (masterPassword && !isLocked) {
            lockApplication();
          }
        }, INACTIVITY_TIMEOUT);
      }

      // Show master password modal
      function showMasterPasswordModal() {
        const modal = document.getElementById('masterPasswordModal');
        modal.style.display = 'block';
        document.getElementById('masterPasswordInput').focus();
      }

      // Hide master password modal
      function hideMasterPasswordModal() {
        const modal = document.getElementById('masterPasswordModal');
        modal.style.display = 'none';
        document.getElementById('masterPasswordInput').value = '';
        document.getElementById('masterPasswordError').style.display = 'none';
      }

      // Submit master password
      async function submitMasterPassword() {
        const password = document.getElementById('masterPasswordInput').value;
        if (!password) {
          document.getElementById('masterPasswordError').textContent = 'Master password is required';
          document.getElementById('masterPasswordError').style.display = 'block';
          return;
        }

        // Store master password (verification will happen when loading items)
        masterPassword = password;
        hideMasterPasswordModal();
        resetInactivityTimer();
        
        // Load items with decryption (this will verify the password if items exist)
        // If password is wrong, loadItems will show an error and lock the app
        await loadItems();
      }

      // Cancel master password entry
      function cancelMasterPassword() {
        hideMasterPasswordModal();
        logout();
      }

      // Lock application
      function lockApplication() {
        isLocked = true;
        masterPassword = null; // Clear from memory
        clearTimeout(inactivityTimer);
        
        // Clear all displayed passwords from the DOM
        document.getElementById('items').innerHTML = '<div class="empty-state">Please unlock the application to view items</div>';
        
        // Show locked overlay
        document.getElementById('lockedOverlay').classList.add('active');
        document.getElementById('unlockPasswordInput').focus();
      }

      // Unlock application
      async function unlockApplication() {
        const password = document.getElementById('unlockPasswordInput').value;
        if (!password) {
          document.getElementById('unlockError').textContent = 'Master password is required';
          document.getElementById('unlockError').style.display = 'block';
          return;
        }

        // Verify password by trying to load items
        masterPassword = password;
        try {
          const response = await authFetch(`${API_BASE}/items?vault_id=${currentVaultId || ''}&masterPassword=${encodeURIComponent(masterPassword)}`);
          const items = await response.json();
          
          // Check if there's a decryption error in any item
          if (response.ok) {
            const hasDecryptionError = items.some(item => item.decryptionError);
            if (hasDecryptionError) {
              document.getElementById('unlockError').textContent = 'Invalid master password';
              document.getElementById('unlockError').style.display = 'block';
              masterPassword = null;
              return;
            }
            
            // If successful, unlock
            isLocked = false;
            document.getElementById('lockedOverlay').classList.remove('active');
            document.getElementById('unlockPasswordInput').value = '';
            document.getElementById('unlockError').style.display = 'none';
            resetInactivityTimer();
            // Reload items to display them
            loadItems();
          } else {
            document.getElementById('unlockError').textContent = 'Invalid master password';
            document.getElementById('unlockError').style.display = 'block';
            masterPassword = null;
          }
        } catch (error) {
          document.getElementById('unlockError').textContent = 'Error verifying password: ' + error.message;
          document.getElementById('unlockError').style.display = 'block';
          masterPassword = null;
        }
      }

      // Get auth token from localStorage
      function getAuthToken() {
        return localStorage.getItem('token');
      }

      // Make authenticated request
      function authFetch(url, options = {}) {
        const token = getAuthToken();
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers
        };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        return fetch(url, {
          ...options,
          headers
        });
      }

      // Show message
      function showMessage(message, type = 'success') {
        const msgEl = document.getElementById('authMessage');
        msgEl.textContent = message;
        msgEl.className = `message ${type}`;
        setTimeout(() => {
          msgEl.className = 'message';
        }, 5000);
      }

      // Register function
      async function register() {
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;

        if (!username || !password) {
          showMessage('Please fill in all fields', 'error');
          return;
        }

        if (password.length < 6) {
          showMessage('Password must be at least 6 characters', 'error');
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            showMessage('Registration successful!', 'success');
            showAuthenticated(data.user);
          } else {
            showMessage(data.error || 'Registration failed', 'error');
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Login function
      async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
          showMessage('Please fill in all fields', 'error');
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            showMessage('Login successful!', 'success');
            showAuthenticated(data.user);
            // Master password modal will be shown by showAuthenticated
          } else {
            showMessage(data.error || 'Login failed', 'error');
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Logout function
      function logout() {
        // Clear master password from memory
        masterPassword = null;
        isLocked = false;
        clearTimeout(inactivityTimer);
        
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        currentVaultId = null;
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('authenticatedSection').classList.add('hidden');
        document.getElementById('lockedOverlay').classList.remove('active');
        document.getElementById('masterPasswordModal').style.display = 'none';
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
        showMessage('Logged out successfully', 'success');
      }

      // Current selected vault
      let currentVaultId = null;

      // Show authenticated UI
      function showAuthenticated(user) {
        document.getElementById('currentUser').textContent = user.username;
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('authenticatedSection').classList.remove('hidden');
        loadVaults();
        // Show master password modal after login
        showMasterPasswordModal();
      }

      // Show register form
      function showRegister() {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
      }

      // Show login form
      function showLogin() {
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
      }

      // Load vaults
      async function loadVaults() {
        try {
          const response = await authFetch(`${API_BASE}/vaults`);
          const vaults = await response.json();

          if (response.ok) {
            const select = document.getElementById('vaultSelect');
            select.innerHTML = '';
            
            if (vaults.length === 0) {
              select.innerHTML = '<option value="">No vaults available</option>';
              return;
            }

            vaults.forEach((vault) => {
              const option = document.createElement('option');
              option.value = vault.id;
              const displayName = vault.is_shared ? `üîó ${vault.name} (Shared)` : vault.name;
              option.textContent = displayName;
              option.dataset.ownerId = vault.owner_id;
              option.dataset.isShared = vault.is_shared || false;
              select.appendChild(option);
            });

            // Select the first vault (should be default vault) and load its items
            if (vaults.length > 0) {
              currentVaultId = vaults[0].id;
              select.value = currentVaultId;
              updateManageButton();
              loadItems();
            }
          } else {
            if (response.status === 401 || response.status === 403) {
              logout();
              showMessage('Session expired. Please login again.', 'error');
            } else {
              showMessage('Error loading vaults', 'error');
            }
          }
        } catch (error) {
          showMessage('Error loading vaults: ' + error.message, 'error');
        }
      }

      // Handle vault change
      function onVaultChange() {
        const select = document.getElementById('vaultSelect');
        currentVaultId = select.value ? parseInt(select.value) : null;
        updateManageButton();
        loadItems();
        resetInactivityTimer();
      }

      // Update manage button visibility
      function updateManageButton() {
        const select = document.getElementById('vaultSelect');
        const manageBtn = document.getElementById('manageVaultBtn');
        if (currentVaultId && select.selectedOptions[0]) {
          const option = select.selectedOptions[0];
          manageBtn.style.display = 'inline-block';
        } else {
          manageBtn.style.display = 'none';
        }
      }

      // Show create vault modal
      function showCreateVaultModal() {
        if (isLocked || !masterPassword) {
          showMessage('Please unlock the application first', 'error');
          return;
        }
        document.getElementById('createVaultModal').style.display = 'block';
        document.getElementById('newVaultName').value = '';
        document.getElementById('createVaultMasterPassword').value = '';
        document.getElementById('createVaultError').style.display = 'none';
        document.getElementById('newVaultName').focus();
      }

      // Hide create vault modal
      function hideCreateVaultModal() {
        document.getElementById('createVaultModal').style.display = 'none';
        document.getElementById('newVaultName').value = '';
        document.getElementById('createVaultMasterPassword').value = '';
        document.getElementById('createVaultError').style.display = 'none';
      }

      // Create vault
      async function createVault() {
        const name = document.getElementById('newVaultName').value.trim();
        const vaultMasterPassword = document.getElementById('createVaultMasterPassword').value;

        if (!name) {
          document.getElementById('createVaultError').textContent = 'Vault name is required';
          document.getElementById('createVaultError').style.display = 'block';
          return;
        }

        if (!vaultMasterPassword) {
          document.getElementById('createVaultError').textContent = 'Master password is required';
          document.getElementById('createVaultError').style.display = 'block';
          return;
        }

        try {
          const response = await authFetch(`${API_BASE}/vaults`, {
            method: 'POST',
            body: JSON.stringify({
              name: name,
              masterPassword: vaultMasterPassword
            })
          });

          const data = await response.json();

          if (response.ok) {
            hideCreateVaultModal();
            showMessage('Vault created successfully!', 'success');
            loadVaults();
          } else {
            document.getElementById('createVaultError').textContent = data.error || 'Failed to create vault';
            document.getElementById('createVaultError').style.display = 'block';
          }
        } catch (error) {
          document.getElementById('createVaultError').textContent = 'Error: ' + error.message;
          document.getElementById('createVaultError').style.display = 'block';
        }
      }

      // Show manage vault modal
      async function showManageVaultModal() {
        if (!currentVaultId) return;

        const select = document.getElementById('vaultSelect');
        const option = select.selectedOptions[0];
        if (!option) return;

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const currentUserId = user.id;

        const vaultName = option.textContent.replace('üîó ', '').replace(' (Shared)', '');
        const isOwner = parseInt(option.dataset.ownerId) === parseInt(currentUserId);
        const isShared = option.dataset.isShared === 'true';

        document.getElementById('managedVaultName').textContent = vaultName;
        document.getElementById('managedVaultType').textContent = isShared ? 'Shared Vault' : 'Personal Vault';
        document.getElementById('vaultMembersSection').style.display = isOwner ? 'block' : 'none';
        document.getElementById('vaultNotOwnedMessage').style.display = !isOwner && isShared ? 'block' : 'none';

        document.getElementById('manageVaultModal').style.display = 'block';
        document.getElementById('addMemberUsername').value = '';
        document.getElementById('addMemberError').style.display = 'none';

        if (isOwner) {
          await loadVaultMembers();
        }
      }

      // Hide manage vault modal
      function hideManageVaultModal() {
        document.getElementById('manageVaultModal').style.display = 'none';
      }

      // Load vault members
      async function loadVaultMembers() {
        if (!currentVaultId) return;

        try {
          const response = await authFetch(`${API_BASE}/vaults/${currentVaultId}/members`);
          const members = await response.json();

          if (response.ok) {
            const membersList = document.getElementById('vaultMembersList');
            if (members.length === 0) {
              membersList.innerHTML = '<div class="empty-state" style="padding: 20px;">No members yet. Add members below.</div>';
            } else {
              membersList.innerHTML = members.map(member => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px;">
                  <div>
                    <strong>${escapeHtml(member.username)}</strong>
                    <div style="font-size: 12px; color: #666;">Added ${new Date(member.created_at).toLocaleDateString()}</div>
                  </div>
                  <button class="danger btn-small" onclick="removeVaultMember(${member.id}, '${escapeHtml(member.username)}')">Remove</button>
                </div>
              `).join('');
            }
          } else {
            document.getElementById('vaultMembersList').innerHTML = '<div class="empty-state" style="padding: 20px; color: red;">Error loading members</div>';
          }
        } catch (error) {
          document.getElementById('vaultMembersList').innerHTML = '<div class="empty-state" style="padding: 20px; color: red;">Error: ' + error.message + '</div>';
        }
      }

      // Add vault member
      async function addVaultMember() {
        const username = document.getElementById('addMemberUsername').value.trim();
        if (!username) {
          document.getElementById('addMemberError').textContent = 'Username is required';
          document.getElementById('addMemberError').style.display = 'block';
          return;
        }

        if (!masterPassword) {
          document.getElementById('addMemberError').textContent = 'Please unlock the application first';
          document.getElementById('addMemberError').style.display = 'block';
          return;
        }

        try {
          const response = await authFetch(`${API_BASE}/vaults/${currentVaultId}/members`, {
            method: 'POST',
            body: JSON.stringify({
              username: username,
              ownerMasterPassword: masterPassword
            })
          });

          const data = await response.json();

          if (response.ok) {
            document.getElementById('addMemberUsername').value = '';
            document.getElementById('addMemberError').style.display = 'none';
            showMessage(data.message || 'Member added successfully! They will need to provide their master password when first accessing the vault.', 'success');
            await loadVaultMembers();
            loadVaults();
          } else {
            document.getElementById('addMemberError').textContent = data.error || 'Failed to add member';
            document.getElementById('addMemberError').style.display = 'block';
          }
        } catch (error) {
          document.getElementById('addMemberError').textContent = 'Error: ' + error.message;
          document.getElementById('addMemberError').style.display = 'block';
        }
      }

      // Remove vault member
      async function removeVaultMember(userId, username) {
        if (!confirm(`Are you sure you want to remove ${username} from this vault?`)) {
          return;
        }

        try {
          const response = await authFetch(`${API_BASE}/vaults/${currentVaultId}/members/${userId}`, {
            method: 'DELETE'
          });

          const data = await response.json();

          if (response.ok) {
            showMessage('Member removed successfully!', 'success');
            await loadVaultMembers();
            loadVaults();
          } else {
            showMessage(data.error || 'Failed to remove member', 'error');
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Parse item description to extract username and notes
      function parseItemDescription(description) {
        if (!description) return { username: '', notes: '' };
        
        // Try to parse structured format: "Username: xxx | Notes: yyy"
        const usernameMatch = description.match(/Username:\s*(.+?)(?:\s*\||$)/i);
        const notesMatch = description.match(/Notes:\s*(.+?)$/i);
        
        if (usernameMatch || notesMatch) {
          return {
            username: usernameMatch ? usernameMatch[1].trim() : '',
            notes: notesMatch ? notesMatch[1].trim() : ''
          };
        }
        
        // Fallback: treat entire description as notes if no structure found
        return { username: '', notes: description };
      }

      // Format item description from username and notes
      function formatItemDescription(username, notes) {
        const parts = [];
        if (username) parts.push(`Username: ${username}`);
        if (notes) parts.push(`Notes: ${notes}`);
        return parts.join(' | ') || '';
      }

      // Load items
      async function loadItems() {
        if (!currentVaultId) {
          document.getElementById('items').innerHTML = '<div class="empty-state">Please select a vault</div>';
          return;
        }

        if (isLocked || !masterPassword) {
          document.getElementById('items').innerHTML = '<div class="empty-state">Please unlock the application to view items</div>';
          return;
        }

        try {
          // Include master password in query for decryption
          const response = await authFetch(`${API_BASE}/items?vault_id=${currentVaultId}&masterPassword=${encodeURIComponent(masterPassword)}`);
          const items = await response.json();

          if (response.ok) {
            const container = document.getElementById('items');
            container.innerHTML = '';
            
            if (items.length === 0) {
              container.innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">üîí</div>
                  <div>No passwords saved yet</div>
                  <div style="margin-top: 10px; font-size: 14px;">Add your first password above</div>
                </div>
              `;
            } else {
              items.forEach((item) => {
                const { username, notes } = parseItemDescription(item.description);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'password-item';
                itemDiv.id = `item-${item.id}`;
                
                const passwordId = `pwd-${item.id}`;
                const hasPassword = item.password && !item.decryptionError;
                const passwordValue = item.password || '';
                const escapedPassword = passwordValue.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                const escapedName = escapeHtml(item.name || 'Untitled');
                const escapedUsername = escapeHtml(username);
                const escapedNotes = escapeHtml(notes);
                const escapedError = item.decryptionError ? escapeHtml(item.decryptionError) : '';
                
                itemDiv.innerHTML = `
                  <div class="password-item-header" onclick="toggleItemDetails(${item.id})">
                    <div class="password-item-title">${escapedName}</div>
                    <button class="danger btn-small" onclick="event.stopPropagation(); deleteItem(${item.id})">üóëÔ∏è Delete</button>
                  </div>
                  <div class="password-item-details" id="details-${item.id}">
                    ${username ? `
                      <div class="password-field">
                        <div class="password-field-label">Username/Email</div>
                        <div class="password-field-value">${escapedUsername}</div>
                      </div>
                    ` : ''}
                    ${hasPassword ? `
                      <div class="password-field">
                        <div class="password-field-label">Password</div>
                        <div class="password-field-value password-hidden" id="${passwordId}" data-password="${escapedPassword}">${'‚Ä¢'.repeat(20)}</div>
                        <div class="password-actions">
                          <button class="btn-small btn-show" onclick="togglePassword('${passwordId}')">üëÅÔ∏è Show</button>
                          <button class="btn-small btn-copy" onclick="copyPassword('${passwordId}')">üìã Copy</button>
                        </div>
                      </div>
                    ` : item.decryptionError ? `
                      <div class="password-field">
                        <div style="color: red; font-size: 12px; padding: 8px; background: #ffebee; border-radius: 4px;">
                          ${escapedError}
                        </div>
                      </div>
                    ` : ''}
                    ${notes ? `
                      <div class="password-field">
                        <div class="password-field-label">Notes</div>
                        <div class="password-field-value" style="white-space: pre-wrap;">${escapedNotes}</div>
                      </div>
                    ` : ''}
                  </div>
                `;
                container.appendChild(itemDiv);
              });
            }
            
            // Check if any items have decryption errors (invalid master password)
            const hasDecryptionError = items.some(item => item.decryptionError);
            if (hasDecryptionError) {
              showMessage('Invalid master password. Please unlock again.', 'error');
              lockApplication();
              return;
            }
            
            resetInactivityTimer();
          } else {
            if (response.status === 401 || response.status === 403) {
              logout();
              showMessage('Session expired. Please login again.', 'error');
            } else {
              // Check if it's a decryption error
              if (items.error && items.error.includes('decrypt')) {
                showMessage('Invalid master password. Please unlock again.', 'error');
                lockApplication();
              } else {
                showMessage(items.error || 'Error loading items', 'error');
              }
            }
          }
        } catch (error) {
          showMessage('Error loading items: ' + error.message, 'error');
        }
      }

      // Toggle item details (expand/collapse)
      function toggleItemDetails(itemId) {
        const header = document.querySelector(`#item-${itemId} .password-item-header`);
        const details = document.getElementById(`details-${itemId}`);
        
        if (details.classList.contains('expanded')) {
          details.classList.remove('expanded');
          header.classList.remove('expanded');
        } else {
          // Close all other items
          document.querySelectorAll('.password-item-details.expanded').forEach(el => {
            el.classList.remove('expanded');
            el.closest('.password-item').querySelector('.password-item-header').classList.remove('expanded');
          });
          
          details.classList.add('expanded');
          header.classList.add('expanded');
        }
        resetInactivityTimer();
      }

      // Toggle password visibility
      function togglePassword(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const password = element.getAttribute('data-password');
        const button = element.parentElement.querySelector('.btn-show');
        
        if (element.textContent.includes('‚Ä¢')) {
          // Show password (it's already decrypted from server)
          element.textContent = password;
          element.classList.remove('password-hidden');
          if (button) button.textContent = 'üôà Hide';
        } else {
          // Hide password
          element.textContent = '‚Ä¢'.repeat(20);
          element.classList.add('password-hidden');
          if (button) button.textContent = 'üëÅÔ∏è Show';
        }
        resetInactivityTimer();
      }

      // Copy password to clipboard
      async function copyPassword(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const password = element.getAttribute('data-password');
        if (!password) return;
        
        try {
          // Use modern clipboard API
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(password);
          } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = password;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
          }
          
          // Show feedback
          const feedback = document.getElementById('copyFeedback');
          feedback.classList.add('show');
          setTimeout(() => {
            feedback.classList.remove('show');
          }, 2000);
          
          resetInactivityTimer();
        } catch (error) {
          showMessage('Failed to copy password: ' + error.message, 'error');
        }
      }

      // Clear form
      function clearForm() {
        document.getElementById('itemWebsite').value = '';
        document.getElementById('itemUsername').value = '';
        document.getElementById('itemPassword').value = '';
        document.getElementById('itemNotes').value = '';
        document.getElementById('passwordStrengthMeter').style.display = 'none';
      }

      // Check password strength using zxcvbn or custom checker
      function checkPasswordStrength() {
        const password = document.getElementById('itemPassword').value;
        const meter = document.getElementById('passwordStrengthMeter');
        const barFill = document.getElementById('strengthBarFill');
        const strengthText = document.getElementById('strengthText');
        const strengthFeedback = document.getElementById('strengthFeedback');

        if (!password) {
          meter.style.display = 'none';
          return;
        }

        meter.style.display = 'block';

        let strength, score, feedbackText;

        // Use zxcvbn if available, otherwise use custom checker
        if (typeof zxcvbn !== 'undefined') {
          const result = zxcvbn(password);
          score = result.score; // 0-4
          strength = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'][score];
          feedbackText = result.feedback.suggestions.length > 0 
            ? result.feedback.suggestions[0] 
            : result.feedback.warning || '';
        } else {
          // Custom strength checker
          const result = calculatePasswordStrength(password);
          score = result.score;
          strength = result.strength;
          feedbackText = result.feedback;
        }

        // Update visual indicator
        const percentage = (score + 1) * 20; // 0-4 -> 20%, 40%, 60%, 80%, 100%
        barFill.style.width = percentage + '%';
        
        // Remove all strength classes
        barFill.className = '';
        strengthText.className = '';
        
        // Add appropriate class based on score
        const strengthClasses = ['strength-very-weak', 'strength-weak', 'strength-fair', 'strength-good', 'strength-strong'];
        const textClasses = ['strength-text-very-weak', 'strength-text-weak', 'strength-text-fair', 'strength-text-good', 'strength-text-strong'];
        
        barFill.classList.add(strengthClasses[score]);
        strengthText.classList.add(textClasses[score]);
        strengthText.textContent = strength;
        strengthFeedback.textContent = feedbackText || '';

        resetInactivityTimer();
      }

      // Custom password strength calculator (fallback if zxcvbn not available)
      function calculatePasswordStrength(password) {
        let score = 0;
        let feedback = '';

        if (password.length === 0) {
          return { score: 0, strength: 'Very Weak', feedback: '' };
        }

        // Length checks
        if (password.length >= 8) score++;
        if (password.length >= 12) score++;
        if (password.length >= 16) score++;

        // Character variety checks
        const hasLower = /[a-z]/.test(password);
        const hasUpper = /[A-Z]/.test(password);
        const hasNumbers = /[0-9]/.test(password);
        const hasSpecial = /[^a-zA-Z0-9]/.test(password);

        if (hasLower) score++;
        if (hasUpper) score++;
        if (hasNumbers) score++;
        if (hasSpecial) score++;

        // Common patterns (penalize)
        const commonPatterns = [
          /12345/, /password/i, /qwerty/i, /abc123/i,
          /letmein/i, /welcome/i, /admin/i, /12345678/
        ];
        
        if (commonPatterns.some(pattern => pattern.test(password))) {
          score = Math.max(0, score - 2);
        }

        // Cap score at 4
        score = Math.min(4, score);

        // Determine strength and feedback
        let strength, feedbackText;
        if (score === 0) {
          strength = 'Very Weak';
          feedbackText = 'Use at least 8 characters';
        } else if (score === 1) {
          strength = 'Weak';
          feedbackText = 'Add uppercase letters and numbers';
        } else if (score === 2) {
          strength = 'Fair';
          feedbackText = 'Add special characters for better security';
        } else if (score === 3) {
          strength = 'Good';
          feedbackText = 'Strong password! Consider making it longer';
        } else {
          strength = 'Strong';
          feedbackText = 'Excellent password strength!';
        }

        // Additional feedback
        if (password.length < 8) {
          feedbackText = 'Use at least 8 characters';
        } else if (!hasLower || !hasUpper) {
          feedbackText = 'Mix uppercase and lowercase letters';
        } else if (!hasNumbers) {
          feedbackText = 'Add numbers';
        } else if (!hasSpecial) {
          feedbackText = 'Add special characters (!@#$%^&*)';
        }

        return { score, strength, feedback: feedbackText };
      }

      // Generate strong password
      function generateStrongPassword() {
        const length = 16; // Default length
        const includeUppercase = true;
        const includeLowercase = true;
        const includeNumbers = true;
        const includeSpecial = true;

        const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const lowercase = 'abcdefghijklmnopqrstuvwxyz';
        const numbers = '0123456789';
        const special = '!@#$%^&*()_+-=[]{}|;:,.<>?';

        let charset = '';
        if (includeLowercase) charset += lowercase;
        if (includeUppercase) charset += uppercase;
        if (includeNumbers) charset += numbers;
        if (includeSpecial) charset += special;

        // Ensure at least one character from each category
        let password = '';
        if (includeLowercase) password += lowercase[Math.floor(Math.random() * lowercase.length)];
        if (includeUppercase) password += uppercase[Math.floor(Math.random() * uppercase.length)];
        if (includeNumbers) password += numbers[Math.floor(Math.random() * numbers.length)];
        if (includeSpecial) password += special[Math.floor(Math.random() * special.length)];

        // Fill the rest randomly
        for (let i = password.length; i < length; i++) {
          password += charset[Math.floor(Math.random() * charset.length)];
        }

        // Shuffle the password
        password = password.split('').sort(() => Math.random() - 0.5).join('');

        // Set password and trigger strength check
        const passwordInput = document.getElementById('itemPassword');
        passwordInput.type = 'text'; // Show generated password briefly
        passwordInput.value = password;
        checkPasswordStrength();
        
        // Hide password after 3 seconds
        setTimeout(() => {
          passwordInput.type = 'password';
        }, 3000);

        resetInactivityTimer();
      }

      // Add item
      async function addItem() {
        if (isLocked || !masterPassword) {
          showMessage('Please unlock the application first', 'error');
          return;
        }

        const website = document.getElementById('itemWebsite').value.trim();
        const username = document.getElementById('itemUsername').value.trim();
        const password = document.getElementById('itemPassword').value;
        const notes = document.getElementById('itemNotes').value.trim();

        if (!website) {
          showMessage('Website/Service name is required', 'error');
          return;
        }

        if (!currentVaultId) {
          showMessage('Please select a vault first', 'error');
          return;
        }

        // Format description with username and notes
        const description = formatItemDescription(username, notes);

        try {
          const response = await authFetch(`${API_BASE}/items`, {
            method: 'POST',
            body: JSON.stringify({ 
              name: website, 
              description: description, 
              password: password || undefined,
              masterPassword: password ? masterPassword : undefined,
              vault_id: currentVaultId 
            })
          });

          const data = await response.json();

          if (response.ok) {
            clearForm();
            loadItems();
            showMessage('Password saved successfully!', 'success');
            resetInactivityTimer();
          } else {
            if (response.status === 401 || response.status === 403) {
              logout();
              showMessage('Session expired. Please login again.', 'error');
            } else {
              showMessage(data.error || 'Failed to add password', 'error');
            }
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Delete item
      async function deleteItem(id) {
        if (!confirm('Are you sure you want to delete this item?')) {
          return;
        }

        try {
          const response = await authFetch(`${API_BASE}/items/${id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            loadItems();
            showMessage('Item deleted successfully!', 'success');
            resetInactivityTimer();
          } else {
            if (response.status === 401 || response.status === 403) {
              logout();
              showMessage('Session expired. Please login again.', 'error');
            } else {
              const data = await response.json();
              showMessage(data.error || 'Failed to delete item', 'error');
            }
          }
        } catch (error) {
          showMessage('Error: ' + error.message, 'error');
        }
      }

      // Ping function
      function ping() {
        fetch(`${API_BASE}/ping`)
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("resp").innerText = JSON.stringify(data, null, 2);
          })
          .catch((err) => {
            document.getElementById("resp").innerText = "Error: " + err;
          });
      }
    </script>
  </body>
</html>
